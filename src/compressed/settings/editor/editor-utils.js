const Debugger={log:t=>{this.debugging&&console.log(t)},error:t=>{this.debugging&&console.error(t)},warn:t=>{this.debugging&&console.warn(t)},debugging:!1,debugging:{enable:function(){this.debugging=!0},disable:function(){this.debugging=!1}}};function initializeEditorShortcuts(){const t=document.getElementById("shortcuts-container");if(!t)return;const e=t.querySelector(".shortcuts-content");if(!e)return;e.innerHTML="";let n=[];window.currentSettings&&window.currentSettings.shortcuts?n=window.currentSettings.shortcuts:(n=[],window.currentSettings&&(window.currentSettings.shortcuts=n)),n.forEach(((t,n)=>{const o=document.createElement("div");o.className="shortcut-link",o.dataset.index=n;const r=document.createElement("img");r.src=getFavicon(t.url),r.alt=t.title,r.className="shortcut-icon";const c=document.createElement("span");c.textContent=t.title,c.className="shortcut-label",o.appendChild(r),o.appendChild(c),e.appendChild(o)}));const o=n.length;if(o>0){const e=Math.min(Math.max(80*o+40,400),800);t.style.width=`${e}px`}else t.style.width="auto"}function getFavicon(t){const e="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItbGluayI+PHBhdGggZD0iTTEwIDEzYTUgNSAwIDAgMCA3LjU0LjU0bDMtM2E1IDUgMCAwIDAtNy4wNy03LjA3bC0xLjcyIDEuNzEiPjwvcGF0aD48cGF0aCBkPSJNMTQgMTFhNSA1IDAgMCAwLTcuNTQtLjU0bC0zIDNhNSA1IDAgMCAwIDcuMDcgNy4wN2wxLjcxLTEuNzEiPjwvcGF0aD48L3N2Zz4=";try{if(!t||""===t.trim())return e;let n;t.startsWith("http://")||t.startsWith("https://")||(t="https://"+t);try{n=new URL(t)}catch(n){return Debugger.error("Invalid URL format:",t,n),e}const o=n.hostname;if(window.faviconCache||(window.faviconCache=new Map),"calendar.google.com"===o){const t=new Date,e="https://ssl.gstatic.com/calendar/images/dynamiclogo_2020q4/calendar_"+t.getDate().toString()+"_2x.png",n=`${o}_${t.toDateString()}`;return window.faviconCache.set(n,e),e}if(window.faviconCache.has(o))return window.faviconCache.get(o);if(!navigator.onLine)return e;const r={"mail.google.com":"https://www.gstatic.com/images/branding/product/1x/gmail_2020q4_32dp.png","drive.google.com":"https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png","docs.google.com":"https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico","sheets.google.com":"https://ssl.gstatic.com/docs/spreadsheets/images/favicon_jfk2.png","slides.google.com":"https://ssl.gstatic.com/docs/presentations/images/favicon5.ico","meet.google.com":"https://www.gstatic.com/meet/favicon_meet_2023_32dp.png","chat.google.com":"https://www.gstatic.com/chat/favicon_chat_32px.png","classroom.google.com":"https://ssl.gstatic.com/classroom/favicon.png","keep.google.com":"https://ssl.gstatic.com/keep/icon_2020q4v2_32dp.png"};if(r[o]){const t=r[o];return window.faviconCache.set(o,t),t}const c=`https://www.google.com/s2/favicons?domain=${o}&sz=64`;return window.faviconCache.set(o,c),c}catch(n){return Debugger.warn("Error getting favicon for URL:",t,n),e}}window.toggleGridSettings=function(){const t=document.getElementById("new-group-type").value;if(document.getElementById("grid-settings").style.display="grid"===t?"block":"none","single"===t){const t=document.getElementById("new-group-links").querySelectorAll(".link-editor");if(t.length>1)for(let e=1;e<t.length;e++)t[e].remove();document.getElementById("add-new-group-link-btn").disabled=!0}else document.getElementById("add-new-group-link-btn").disabled=!1},window.getFavicon=getFavicon;let originalShortcuts=[];function setupShortcutsEditorPopup(){Debugger.log("Setting up shortcuts editor popup");const t=document.getElementById("shortcuts-editor-popup");if(!t)return void Debugger.error("Shortcuts editor popup not found!");const e=document.getElementById("shortcuts-list-container");if(!e)return void Debugger.error("Shortcuts list container not found!");e.innerHTML="",originalShortcuts=JSON.parse(JSON.stringify(window.currentSettings.shortcuts||[])),window.currentSettings.shortcuts&&window.currentSettings.shortcuts.length>0?window.currentSettings.shortcuts.forEach(((t,n)=>{addShortcutToEditor(e,t,n)})):addShortcutToEditor(e,{title:"",url:""},0);const n=document.getElementById("save-shortcuts-btn");if(n){Debugger.log("Setting up save button"),n.replaceWith(n.cloneNode(!0));document.getElementById("save-shortcuts-btn").onclick=function(){Debugger.log("Save button clicked"),saveShortcutsFromEditor(),t.style.display="none"}}const o=document.getElementById("cancel-shortcuts-btn");if(o){Debugger.log("Setting up cancel button"),o.replaceWith(o.cloneNode(!0));document.getElementById("cancel-shortcuts-btn").onclick=function(){Debugger.log("Cancel button clicked"),window.currentSettings.shortcuts=JSON.parse(JSON.stringify(originalShortcuts)),initializeEditorShortcuts(),t.style.display="none"}}const r=document.getElementById("add-shortcut-list-btn");if(r){Debugger.log("Setting up add button"),r.replaceWith(r.cloneNode(!0));document.getElementById("add-shortcut-list-btn").onclick=function(){Debugger.log("Add button clicked");const t=e.children.length;addShortcutToEditor(e,{title:"",url:""},t)}}}function createShortcutsEditorPopup(){const t=document.createElement("div");t.innerHTML='\n    <div id="shortcuts-editor-popup" class="popup" style="display: none;">\n        <div class="popup-content">\n            <h2>Edit Shortcuts</h2>\n            <p>Customize the shortcuts that appear below the search bar.</p>\n            \n            <div id="shortcuts-list-container">\n                \x3c!-- Shortcuts will be added here --\x3e\n            </div>\n            \n            <div class="popup-buttons">\n                <button id="add-shortcut-btn">Add Shortcut</button>\n                <button class="secondary" id="cancel-shortcuts-btn">Cancel</button>\n                <button class="primary" id="save-shortcuts-btn">Save Shortcuts</button>\n            </div>\n        </div>\n    </div>\n    \n    \x3c!-- Shortcut edit form popup --\x3e\n    <div id="shortcut-edit-popup" class="popup" style="display: none;">\n        <div class="popup-content">\n            <h2>Edit Shortcut</h2>\n            \n            <div class="form-group">\n                <label for="shortcut-title">Shortcut Name:</label>\n                <input type="text" id="shortcut-title" placeholder="e.g. Google">\n            </div>\n            \n            <div class="form-group">\n                <label for="shortcut-url">URL:</label>\n                <input type="url" id="shortcut-url" placeholder="e.g. https://www.google.com">\n            </div>\n            \n            <div class="popup-buttons">\n                <button class="secondary" id="cancel-shortcut-edit-btn">Cancel</button>\n                <button class="primary" id="save-shortcut-edit-btn">Save Shortcut</button>\n            </div>\n        </div>\n    </div>\n    ',document.body.appendChild(t.firstElementChild),document.body.appendChild(t.firstElementChild),document.getElementById("cancel-shortcuts-btn").addEventListener("click",(function(){document.getElementById("shortcuts-editor-popup").style.display="none"})),document.getElementById("save-shortcuts-btn").addEventListener("click",(function(){updateShortcutsMock(),document.getElementById("shortcuts-editor-popup").style.display="none"})),document.getElementById("add-shortcut-btn").addEventListener("click",(function(){openShortcutEditor()})),document.getElementById("cancel-shortcut-edit-btn").addEventListener("click",(function(){document.getElementById("shortcut-edit-popup").style.display="none"})),document.getElementById("save-shortcut-edit-btn").addEventListener("click",saveShortcutChanges)}window.openShortcutsEditor=function(){Debugger.log("Opening shortcuts editor");const t=document.getElementById("shortcuts-editor-popup");if(!t)return void Debugger.error("Shortcuts editor popup not found!");const e=document.getElementById("shortcuts-list-container");if(!e)return void Debugger.error("Shortcuts list container not found!");e.innerHTML="",window.originalShortcuts=JSON.parse(JSON.stringify(window.currentSettings.shortcuts||[])),window.currentSettings.shortcuts&&window.currentSettings.shortcuts.length>0?window.currentSettings.shortcuts.forEach(((t,n)=>{addShortcutToEditor(e,t,n)})):addShortcutToEditor(e,{title:"",url:""},0);const n=document.getElementById("save-shortcuts-btn");n&&(n.onclick=function(){const n=[];e.querySelectorAll(".shortcut-editor").forEach((t=>{const e=t.querySelector(".shortcut-title"),o=t.querySelector(".shortcut-url"),r=e.value.trim(),c=o.value.trim();if(!r||!c)return;let i=c;i.startsWith("http://")||i.startsWith("https://")||(i="https://"+i),n.push({title:r,url:i})})),window.currentSettings.shortcuts=n,saveShortcutsToStorage(),initializeEditorShortcuts(),t.style.display="none"});const o=document.getElementById("cancel-shortcuts-btn");o&&(o.onclick=function(){window.currentSettings.shortcuts=JSON.parse(JSON.stringify(window.originalShortcuts)),initializeEditorShortcuts(),t.style.display="none"});const r=document.getElementById("add-shortcut-list-btn");r&&(r.onclick=function(){const t=e.children.length;addShortcutToEditor(e,{title:"",url:""},t)}),t.style.display="flex"};let editingShortcutIndex=-1;function saveShortcutsToStorage(){Debugger.log("Saving shortcuts to storage:",window.currentSettings.shortcuts),window.currentSettings.shortcuts||(window.currentSettings.shortcuts=[]);try{"undefined"!=typeof chrome&&chrome.storage?chrome.storage.sync?chrome.storage.sync.set({settings:window.currentSettings},(function(){Debugger.log("Shortcuts saved to chrome.storage.sync")})):chrome.storage.local.set({settings:window.currentSettings},(function(){Debugger.log("Shortcuts saved to chrome.storage.local")})):(localStorage.setItem("settings",JSON.stringify(window.currentSettings)),Debugger.log("Shortcuts saved to localStorage"))}catch(t){Debugger.error("Error saving shortcuts:",t)}}function renderShortcutsList(){const t=document.getElementById("shortcuts-list-container");if(t){if(t.innerHTML="",!window.currentSettings.shortcuts||0===window.currentSettings.shortcuts.length)return window.currentSettings.shortcuts||(window.currentSettings.shortcuts=[]),void addShortcutInput(t);window.currentSettings.shortcuts.forEach(((e,n)=>{addShortcutInput(t,e,n)}))}}function addShortcutInput(t,e={title:"",url:""},n=null){const o=document.createElement("div");o.className="link-editor shortcut-editor";const r=t.querySelectorAll(".shortcut-editor").length,c=document.createElement("select");c.className="link-index";for(let t=0;t<=r;t++){const e=document.createElement("option");e.value=t,e.text=t+1,c.appendChild(e)}c.value=null!==n?n:r,o.appendChild(c);const i=document.createElement("input");i.type="text",i.className="link-title",i.value=e.title||"",o.appendChild(i);const s=document.createElement("input");s.type="url",s.className="link-url",s.value=e.url||"",o.appendChild(s);const d=document.createElement("img");d.className="shortcut-preview-icon",d.src=e.url?getFavicon(e.url):"",d.alt="Favicon",d.style.width="24px",d.style.height="24px",d.style.marginRight="8px",o.appendChild(d),s.addEventListener("blur",(()=>{s.value&&(d.src=getFavicon(s.value))}));const l=document.createElement("button");l.className="remove-link-btn",l.textContent="Remove",l.addEventListener("click",(()=>o.remove())),o.appendChild(l),c.addEventListener("change",(t=>reorderShortcutInput(o,parseInt(t.target.value)))),null!==n&&n<t.children.length?t.insertBefore(o,t.children[n]):t.appendChild(o),updateShortcutIndexes(t)}function reorderShortcutInput(t,e){const n=t.parentElement;Array.from(n.children).indexOf(t)!==e&&(n.removeChild(t),e>=n.children.length?n.appendChild(t):n.insertBefore(t,n.children[e]),updateShortcutIndexes(n))}function updateShortcutIndexes(t){const e=t.querySelectorAll(".shortcut-editor");e.forEach(((t,n)=>{const o=t.querySelector(".link-index"),r=parseInt(o.value);o.innerHTML="";for(let t=0;t<e.length;t++){const e=document.createElement("option");e.value=t,e.text=t+1,o.appendChild(e)}r<e.length?o.value=r:o.value=n}))}function gatherShortcutsFromEditor(){const t=document.getElementById("shortcuts-list-container");if(!t)return[];const e=t.querySelectorAll(".shortcut-editor");if(!e.length)return[];const n=[],o=new Array(e.length).fill(null);return e.forEach((t=>{const e=t.querySelector(".link-index"),n=t.querySelector(".link-title"),r=t.querySelector(".link-url"),c=parseInt(e.value),i=n.value.trim(),s=r.value.trim();if(!i&&!s)return;let d=s;!s||s.startsWith("http://")||s.startsWith("https://")||(d="https://"+s),o[c]={title:i,url:d}})),o.forEach((t=>{t&&n.push(t)})),n}function addShortcutToEditor(t,e,n){const o=document.createElement("div");o.className="shortcut-editor";const r=document.createElement("div");r.className="shortcut-order";const c=document.createElement("button");c.className="order-btn up-btn",c.textContent="↑",c.title="Move up",c.disabled=0===n,c.style.opacity=0===n?"0.5":"1",c.addEventListener("click",(()=>moveShortcutInEditor(o,-1))),r.appendChild(c);const i=document.createElement("button");i.className="order-btn down-btn",i.textContent="↓",i.title="Move down",i.addEventListener("click",(()=>moveShortcutInEditor(o,1))),r.appendChild(i),o.appendChild(r);const s=document.createElement("input");s.type="text",s.className="shortcut-title",s.value=e.title||"",s.setAttribute("required","required"),o.appendChild(s);const d=document.createElement("input");d.type="url",d.className="shortcut-url",d.value=e.url||"",d.setAttribute("required","required"),d.addEventListener("blur",(()=>{d.value&&(l.src=getFavicon(d.value))})),o.appendChild(d);const l=document.createElement("img");l.className="shortcut-preview",l.src=e.url?getFavicon(e.url):"",l.alt="Preview",l.style.width="24px",l.style.height="24px",o.appendChild(l);const u=document.createElement("button");u.className="remove-shortcut-btn",u.textContent="✕",u.title="Remove shortcut",u.addEventListener("click",(()=>{o.remove(),updateOrderButtons(t)})),o.appendChild(u),n<t.children.length?t.insertBefore(o,t.children[n]):t.appendChild(o),updateOrderButtons(t)}function moveShortcutInEditor(t,e){const n=t.parentElement,o=Array.from(n.children),r=o.indexOf(t)+e;r<0||r>=o.length||(n.removeChild(t),r>=o.length-1?n.appendChild(t):n.insertBefore(t,o[r]),updateOrderButtons(n))}function updateOrderButtons(t){const e=Array.from(t.children);e.forEach(((t,n)=>{const o=t.querySelector(".up-btn"),r=t.querySelector(".down-btn");o&&(o.disabled=0===n,o.style.opacity=0===n?"0.5":"1"),r&&(r.disabled=n===e.length-1,r.style.opacity=n===e.length-1?"0.5":"1")}))}function saveShortcutsFromEditor(){const t=document.getElementById("shortcuts-list-container");if(!t)return;const e=t.querySelectorAll(".shortcut-editor"),n=[];e.forEach((t=>{const e=t.querySelector(".shortcut-title"),o=t.querySelector(".shortcut-url"),r=e.value.trim(),c=o.value.trim();if(!r||!c)return;let i=c;i.startsWith("http://")||i.startsWith("https://")||(i="https://"+i),n.push({title:r,url:i})})),window.currentSettings.shortcuts=n,initializeEditorShortcuts(),saveShortcutsToStorage()}function updateShortcutsMock(){initializeEditorShortcuts();const t=document.getElementById("shortcuts-editor-mock");if(t){const e=t.querySelector(".shortcuts-content");if(e){e.innerHTML="";const n=window.currentSettings.shortcuts||[];n.forEach(((t,n)=>{const o=document.createElement("div");o.className="shortcut-mock",o.innerHTML=`\n                    <img src="${getFavicon(t.url)}" alt="${t.title}">\n                    <div class="shortcut-mock-title">${t.title}</div>\n                `,o.addEventListener("click",(function(){openShortcutEditor(n)})),e.appendChild(o)}));const o=n.length;if(o>0){const e=Math.min(Math.max(90*o+40,300),800);t.style.width=`${e}px`}else t.style.width="auto"}}saveShortcutsToStorage()}document.addEventListener("DOMContentLoaded",(function(){Debugger.log("Editor utils initialized"),Debugger.log("getFavicon function is available:","function"==typeof window.getFavicon),document.querySelectorAll("#edit-shortcuts-btn, .edit-shortcuts-btn").forEach((t=>{if(t){Debugger.log("Found Edit Shortcuts button, adding direct click handler");const e=t.cloneNode(!0);t.parentNode.replaceChild(e,t),e.setAttribute("onclick","openShortcutsEditor()"),e.addEventListener("click",(function(){Debugger.log("Edit Shortcuts button clicked"),openShortcutsEditor()}))}}));const t=document.createElement("style");t.textContent="\n    /* Size fix for link-grid */\n    .link-grid {\n        height: 70px !important; /* Match with newtab page */\n    }\n    \n    /* Ensure grid alignment is consistent */\n    .grid {\n        align-items: center !important;\n    }\n    \n    /* Make sure editor elements use translations properly */\n    .editor-group {\n        transform: translate(-50%, -50%) !important;\n    }\n    \n    /* Shortcuts editor styling */\n    #shortcuts-editor-popup .popup-content {\n        max-width: 700px;\n    }\n    \n    #shortcuts-list-container {\n        max-height: 400px;\n        overflow-y: auto;\n        margin-bottom: 20px;\n        margin-top: 20px;\n        border: 1px solid rgba(0, 0, 0, 0.1);\n        border-radius: 4px;\n        padding: 10px;\n    }\n    \n    .shortcut-editor {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        margin-bottom: 10px;\n        padding: 10px;\n        border: 1px solid rgba(0, 0, 0, 0.1);\n        border-radius: 4px;\n        background-color: var(--all-background-color);\n    }\n    \n    .shortcut-order {\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n    }\n    \n    .order-btn {\n        width: 24px;\n        height: 24px;\n        padding: 0;\n        border: none;\n        background-color: var(--primary-color);\n        color: white;\n        border-radius: 4px;\n        font-size: 14px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    \n    .order-btn:disabled {\n        opacity: 0.5;\n        cursor: not-allowed;\n    }\n    \n    .shortcut-title,\n    .shortcut-url {\n        flex: 1;\n        padding: 8px;\n        border: 1px solid rgba(0, 0, 0, 0.2);\n        border-radius: 4px;\n    }\n    \n    .shortcut-preview {\n        width: 24px;\n        height: 24px;\n        object-fit: contain;\n    }\n    \n    .remove-shortcut-btn {\n        width: 28px;\n        height: 28px;\n        background-color: #f44336;\n        color: white;\n        border: none;\n        border-radius: 4px;\n        font-size: 14px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    \n    /* Make sure the mock search bar and shortcuts are visible in editor */\n    #search-editor-mock, #shortcuts-editor-mock {\n        background-color: var(--group-background-color);\n        border-radius: 8px;\n        padding: 10px;\n        margin: 10px 0;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    \n    #shortcuts-editor-mock {\n        display: flex;\n        gap: 10px;\n        padding: 12px;\n    }\n    \n    .shortcut-mock {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        width: 60px;\n        text-align: center;\n    }\n    \n    .shortcut-mock img {\n        width: 32px;\n        height: 32px;\n        margin-bottom: 5px;\n    }\n    \n    .shortcut-mock-title {\n        font-size: 12px;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        width: 100%;\n    }\n    ",document.head.appendChild(t),initializeEditorShortcuts();const e=document.getElementById("shortcuts-container");e&&"function"==typeof window.initDraggableElement&&window.initDraggableElement(e,"shortcutsPosition");const n=document.getElementById("shortcuts-editor-mock");n&&(n.style.display="none")}));