const Debugger={log:e=>{this.debugging&&console.log(e)},error:e=>{this.debugging&&console.error(e)},warn:e=>{this.debugging&&console.warn(e)},debugging:!1,debugging:{enable:function(){this.debugging=!0},disable:function(){this.debugging=!1}}};async function fetchSettingsAndGroups(){if("undefined"!=typeof chrome&&chrome.storage&&chrome.storage.sync){Debugger.log("Using Chrome storage API");const{settings:e,groups:t,groupsLocation:n}=await chrome.storage.sync.get(["settings","groups","groupsLocation"]);let o=t;if("local"===n){o=(await chrome.storage.local.get(["groups"])).groups||[]}return{settings:e||defaultSettings,groups:o||[]}}return{settings:JSON.parse(localStorage.getItem("settings")||"null")||defaultSettings,groups:JSON.parse(localStorage.getItem("groups")||"[]")}}async function initializePage(){try{const e=measureLoadTime("Page initialization"),[t,n]=await Promise.all([getFromStorage("settings"),getFromStorage("groups")]);applyTheme(),initializeSearch(),requestAnimationFrame((()=>{Promise.all([renderGroups(n),initializeHeaderLinks(),initializeAppsDropdown()]).then((()=>{setTimeout((()=>{loadWidgets(),setupImageDrop()}),100),e()}))}))}catch(e){Debugger.error("Error initializing:",e)}}function measureLoadTime(e){const t=performance.now();return()=>{const n=performance.now()-t;Debugger.log(`${e} took ${n}ms`)}}const endMeasure=measureLoadTime("Group loading"),container=document.getElementById("groups-container"),searchContainer=document.getElementById("search-container"),searchForm=document.getElementById("search-form"),searchInput=document.getElementById("search-input"),searchIcon=document.getElementById("search-icon"),defaultSettings={theme:"light",useCustomBackground:!1,backgroundURL:"",backgroundImage:null,showSearch:!0,searchEngine:"google",searchBarPosition:{x:540,y:360},headerLinks:[{name:"Gmail",url:"https://mail.google.com"},{name:"Photos",url:"https://photos.google.com"},{name:"Search Labs",url:"https://labs.google.com"}],apps:[{name:"Account",icon:"https://www.gstatic.com/images/branding/product/1x/avatar_square_blue_32dp.png",url:"https://myaccount.google.com/"},{name:"Search",icon:"https://www.gstatic.com/images/branding/product/1x/googleg_32dp.png",url:"https://www.google.com/"},{name:"Maps",icon:"https://maps.gstatic.com/mapfiles/maps_lite/favicon_maps.ico",url:"https://maps.google.com/"},{name:"YouTube",icon:"https://www.youtube.com/s/desktop/1c3bfd26/img/favicon_32x32.png",url:"https://youtube.com/"},{name:"Play",icon:"https://www.gstatic.com/images/branding/product/1x/play_round_32dp.png",url:"https://play.google.com/"},{name:"Gmail",icon:"https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico",url:"https://mail.google.com/"},{name:"Drive",icon:"https://ssl.gstatic.com/images/branding/product/1x/drive_32dp.png",url:"https://drive.google.com/"},{name:"Calendar",icon:"https://ssl.gstatic.com/calendar/images/favicon_v2021_32.ico",url:"https://calendar.google.com/"},{name:"Photos",icon:"https://ssl.gstatic.com/images/branding/product/1x/photos_32dp.png",url:"https://photos.google.com/"}]};let currentSettings={...defaultSettings};function calculatePosition(e,t){const n=window.innerWidth,o=window.innerHeight;let r,a;if("string"==typeof e&&e.endsWith("%"))r=parseFloat(e)/100;else{const t=parseFloat(e);r=isNaN(t)?.5:t/n}if("string"==typeof t&&t.endsWith("%"))a=parseFloat(t)/100;else{const e=parseFloat(t);a=isNaN(e)?.5:e/o}r=Math.max(0,Math.min(1,r)),a=Math.max(0,Math.min(1,a));return{x:r*n,y:a*o,percentX:r,percentY:a}}const newGroup={stack:function(e,t,n,o){let r=document.createElement("div");if(r.classList.add("group"),r.classList.add("stack"),r.classList.add("glass-background"),o&&o.trim().length>0){let e=document.createElement("div");e.classList.add("group-header"),e.textContent=o,r.appendChild(e)}let a=document.createElement("ul");e.forEach((async e=>{let t=getFavicon(e.url);a.innerHTML+=newLink.stack(e.title,e.url,t)})),r.appendChild(a);const s=calculatePosition(t,n);return r.style.position="absolute",r.style.top=100*s.percentY+"%",r.style.left=100*s.percentX+"%",r.style.transform="translate(-50%, -50%)",r},grid:function(e,t,n,o,r,a){let s=document.createElement("div");if(s.classList.add("group"),s.classList.add("glass-background"),a&&a.trim().length>0){let e=document.createElement("div");e.classList.add("group-header"),e.textContent=a,s.appendChild(e)}let i=document.createElement("div");i.classList.add("grid"),e.forEach((async e=>{let t=getFavicon(e.url);i.innerHTML+=newLink.grid(e.title,e.url,t)})),s.appendChild(i);const c=calculatePosition(t,n);return s.style.position="absolute",s.style.top=100*c.percentY+"%",s.style.left=100*c.percentX+"%",s.style.transform="translate(-50%, -50%)",i.style.display="grid",i.style.gridTemplateColumns=`repeat(${r}, 1fr)`,i.style.gridTemplateRows=`repeat(${o}, 1fr)`,i.style.gridGap="10px",s},single:function(e,t,n,o){let r=document.createElement("div");if(r.classList.add("glass-background"),o&&o.trim().length>0){let e=document.createElement("div");e.classList.add("group-header"),e.textContent=o,r.appendChild(e)}let a=getFavicon(e.url);r.innerHTML+=newLink.single(e.title,e.url,a),r.classList.add("group"),r.classList.add("single");const s=calculatePosition(t,n);return r.style.position="absolute",r.style.top=100*s.percentY+"%",r.style.left=100*s.percentX+"%",r.style.transform="translate(-50%, -50%)",r}},newLink={stack:function(e,t,n){return`\n            <li class="link-stack">\n                <a href="${t}"><img class="link-image" src="${n}"/>${e}</a>\n            </li>\n        `},grid:function(e,t,n){return`\n            <a href="${t}"class="link-grid">\n                <img class="link-image" src="${n}"/>\n                <span class="grid-link-title">${e}</span>\n            </a>\n        `},single:function(e,t,n){return`\n            <a href="${t}" class="link-single">\n                <img src="${n}"/>\n                <span>${e}</span>\n            </a>\n        `}};async function lazyRenderGroups(e){const t=document.getElementById("groups-container");t.innerHTML="";const n=e.map((e=>{const n="string"==typeof e.x&&e.x.endsWith("%")?e.x:parseFloat(e.x)/window.innerWidth*100+"%",o=createGroupPlaceholder({styleTop:"string"==typeof e.y&&e.y.endsWith("%")?e.y:parseFloat(e.y)/window.innerHeight*100+"%",styleLeft:n});return t.appendChild(o),o})),o=()=>{n.forEach(((t,n)=>{renderGroupContent(t,e[n])}))};"requestIdleCallback"in window?requestIdleCallback(o,{timeout:200}):requestAnimationFrame(o)}function deferNonCritical(){const e=()=>{loadWidgets(),setupImageDrop()};"requestIdleCallback"in window?requestIdleCallback(e):setTimeout(e,200)}function initializeSearch(){const e={google:{url:"https://www.google.com/search?q=",icon:"https://www.google.com/favicon.ico"},bing:{url:"https://www.bing.com/search?q=",icon:"https://www.bing.com/favicon.ico"},duckduckgo:{url:"https://duckduckgo.com/?q=",icon:"https://duckduckgo.com/favicon.ico"},yahoo:{url:"https://search.yahoo.com/search?p=",icon:"https://www.yahoo.com/favicon.ico"}},t=e[currentSettings.searchEngine]||e.google;if(searchIcon.src=t.icon,searchForm.addEventListener("submit",(function(e){e.preventDefault();const n=searchInput.value.trim();n&&(window.location.href=t.url+encodeURIComponent(n))})),currentSettings.searchBarPosition){const e=calculatePosition(currentSettings.searchBarPosition.x,currentSettings.searchBarPosition.y);searchContainer.style.top=100*e.percentY+"%",searchContainer.style.left=100*e.percentX+"%",searchContainer.style.transform="translate(-50%, -50%)"}searchContainer.style.display=currentSettings.showSearch?"block":"none"}function applyTheme(){Array.from(document.body.classList).filter((e=>e.startsWith("theme-"))).forEach((e=>document.body.classList.remove(e)));const e=currentSettings.theme||"light",t=e.split("-")[0],n=new Set(["dark","midnight","emerald","slate","deep","nord","cyber"]);document.documentElement.style.setProperty("--all-background-color",`var(--${e}-background, #f1faee)`),document.documentElement.style.setProperty("--group-background-color",`var(--${e}-secondary, #a8dadc)`),document.documentElement.style.setProperty("--text-color",`var(--${e}-text, #1d3557)`),document.documentElement.style.setProperty("--accent-color",`var(--${e}-accent, #e63946)`),document.documentElement.style.setProperty("--primary-color",`var(--${e}-primary, #457b9d)`),document.documentElement.style.setProperty("--contrast-text-color",n.has(t)?"#ffffff":"#000000");const o=getComputedStyle(document.documentElement).getPropertyValue("--all-background-color");document.body.style.backgroundColor=o,currentSettings.useCustomBackground||(document.documentElement.style.setProperty("--background-image","none"),document.body.classList.remove("bg-loaded")),document.body.classList.add(`theme-${t}`),currentSettings.fontSize&&document.documentElement.style.setProperty("--base-font-size",`${currentSettings.fontSize}px`),currentSettings.groupScale&&document.documentElement.style.setProperty("--group-scale",""+currentSettings.groupScale/100),currentSettings.spacingScale&&document.documentElement.style.setProperty("--spacing-scale",""+currentSettings.spacingScale/100),currentSettings.highContrast&&(document.documentElement.style.setProperty("--text-color","#000000"),document.documentElement.style.setProperty("--accent-color","#FF0000"));const r=document.querySelector("#settings-button img");r&&(r.style.filter=n.has(t)?"invert(1)":"invert(0)")}function setupImageDrop(){const e=document.getElementById("search-container"),t=document.getElementById("search-form");document.getElementById("search-input");if(!e)return void Debugger.error("Search container element not found");const n=document.createElement("div");n.className="drop-indicator",n.textContent="Drop image here to search",n.style.display="none",n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.display="none",n.style.alignItems="center",n.style.justifyContent="center",n.style.backgroundColor="rgba(0,0,0,0.1)",n.style.borderRadius="24px",n.style.fontWeight="bold",n.style.zIndex="10",e.appendChild(n);let o=!1;document.addEventListener("dragover",(r=>{r.preventDefault(),r.dataTransfer&&r.dataTransfer.types&&r.dataTransfer.types.includes("Files")&&(o=!0,e.classList.add("drop-active"),t&&(t.style.display="none"),n.style.display="flex")})),document.addEventListener("dragleave",(r=>{r.relatedTarget&&e.contains(r.relatedTarget)||(o=!1,e.classList.remove("drop-active"),t&&(t.style.display="flex"),n.style.display="none")})),document.addEventListener("drop",(r=>{if(r.preventDefault(),o=!1,e.classList.remove("drop-active"),t&&(t.style.display="flex"),n.style.display="none",r.dataTransfer&&r.dataTransfer.files&&r.dataTransfer.files.length>0){const e=r.dataTransfer.files[0];e.type&&e.type.startsWith("image/")?performImageSearch(e):Debugger.warn("Dropped file is not an image:",e.type)}})),document.addEventListener("dragend",(()=>{o&&(o=!1,e.classList.remove("drop-active"),t&&(t.style.display="flex"),n.style.display="none")}))}function performImageSearch(e){if(e)try{const t=currentSettings.searchEngine||"google",n=new FileReader;n.onerror=function(e){Debugger.error("Error reading image file:",e),alert("There was an error processing your image. Please try again.")},n.onload=function(e){try{e.target.result;let n;switch(t){case"google":default:n="https://images.google.com/";break;case"bing":n="https://www.bing.com/images/search?view=detailv2&iss=sbiupload";break;case"yandex":n="https://yandex.com/images/search"}window.open(n,"_blank")}catch(e){Debugger.error("Error navigating to search URL:",e),window.open("https://images.google.com/","_blank")}},n.readAsDataURL(e)}catch(e){Debugger.error("Error in image search functionality:",e),alert("There was an error processing your image search. Please try again.")}else Debugger.error("No image file provided for search")}function initializeHeaderLinks(){const e=document.querySelector(".header-nav"),t=e.querySelector(".apps-dropdown-container");for(;e.firstChild&&e.firstChild!==t;)e.removeChild(e.firstChild);currentSettings.headerLinks&&currentSettings.headerLinks.length>0&&currentSettings.headerLinks.forEach((n=>{const o=document.createElement("a");o.href=n.url,o.className="nav-link",o.textContent=n.name,e.insertBefore(o,t)}))}function initializeAppsDropdown(){const e=document.getElementById("apps-toggle"),t=document.getElementById("apps-dropdown"),n=document.querySelector(".apps-grid");if(e.addEventListener("click",(function(){t.style.display="block"===t.style.display?"none":"block"})),document.addEventListener("click",(function(n){e.contains(n.target)||t.contains(n.target)||(t.style.display="none")})),currentSettings.apps&&currentSettings.apps.length>0&&(n.innerHTML="",currentSettings.apps.forEach((e=>{const t=document.createElement("a");t.href=e.url,t.className="app-item";const o=document.createElement("img");o.src=getFavicon(e.url),o.alt=e.name,o.className="app-icon",o.onerror=function(){o.src!==e.icon&&(o.src=e.icon)};const r=document.createElement("span");r.textContent=e.name,r.className="app-name",t.appendChild(o),t.appendChild(r),n.appendChild(t)})),window.location.href.includes("editor"))){const e=document.createElement("div");e.className="apps-footer";const n=document.createElement("a");n.href="#",n.className="customize-apps",n.textContent="Customize apps",n.addEventListener("click",(function(e){e.preventDefault(),"function"==typeof openAppsManager&&openAppsManager()})),e.appendChild(n),t.appendChild(e)}}function renderGroupContent(e,t){let n;switch(t.type){case"stack":n=newGroup.stack(t.links,t.x,t.y,t.title);break;case"grid":n=newGroup.grid(t.links,t.x,t.y,t.rows||1,t.columns||1,t.title);break;case"single":t.links&&t.links.length>0&&(n=newGroup.single(t.links[0],t.x,t.y,t.title));break;default:return}if(Array.isArray(t.links)&&t.links.length>20&&n){const e=n.querySelector("ul")||n.querySelector(".grid");if(e){const o=Array.from(e.children);o.slice(20).forEach((e=>e.remove()));const r=document.createElement("button");r.textContent=`Show ${t.links.length-20} more`,r.className="show-more-links",r.onclick=()=>{e.innerHTML="",o.forEach((t=>e.appendChild(t))),r.remove()},n.appendChild(r)}}e.replaceWith(n)}function isColorDark(e){let t,n,o;if(e.startsWith("#")){let r=e.substring(1);3===r.length?(t=parseInt(r.charAt(0)+r.charAt(0),16),n=parseInt(r.charAt(1)+r.charAt(1),16),o=parseInt(r.charAt(2)+r.charAt(2),16)):(t=parseInt(r.substring(0,2),16),n=parseInt(r.substring(2,4),16),o=parseInt(r.substring(4,6),16))}else{if(!e.startsWith("rgb"))return!1;{const r=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);if(!r)return!1;t=parseInt(r[1]),n=parseInt(r[2]),o=parseInt(r[3])}}return(299*t+587*n+114*o)/1e3<128}async function loadWidgets(){Debugger.log("Loading widgets from storage...");try{let e=[];if("undefined"!=typeof chrome&&chrome.storage)if(Debugger.log("Chrome storage API available"),chrome.storage.sync){const t=await chrome.storage.sync.get(["groups","groupsLocation"]);if("local"===t.groupsLocation){Debugger.log("Groups are stored in local storage according to sync reference");e=(await chrome.storage.local.get(["groups"])).groups||[]}else if(t.groups&&t.groups.length>0)Debugger.log("Groups found in sync storage"),e=t.groups;else{Debugger.log("Groups not found in sync storage, checking local storage");e=(await chrome.storage.local.get(["groups"])).groups||[]}}else{Debugger.log("Sync storage not available, trying local storage");e=(await chrome.storage.local.get(["groups"])).groups||[]}else{Debugger.warn("Chrome storage API not available, using localStorage fallback");const t=localStorage.getItem("groups");e=t?JSON.parse(t):[]}if(e&&e.length>0){Debugger.log(`Found ${e.length} groups in storage, checking for widgets...`);const t=e.filter((e=>"widget"===e.type));t.length>0?(Debugger.log(`Found ${t.length} widgets to display`),t.forEach(((e,t)=>{if(Debugger.log(`Creating widget: ${e.title} (${e.widgetType})`),"undefined"!=typeof WIDGET_TEMPLATES&&"function"==typeof WIDGET_TEMPLATES.createWidget){const n=WIDGET_TEMPLATES.createWidget(e);n&&(document.getElementById("groups-container").appendChild(n),Array.isArray(WIDGETS)&&WIDGETS.push({id:`widget-${e.widgetType}-${Date.now()}-${t}`,element:n,data:e}))}else Debugger.error("Widget templates not available")}))):Debugger.log("No widgets found in groups")}else Debugger.log("No groups found in storage")}catch(e){Debugger.error("Error loading widgets:",e)}finally{endMeasure()}}function handleWindowResize(){if(loadGroups(),loadWidgets(),currentSettings.searchBarPosition){const e=calculatePosition(currentSettings.searchBarPosition.x,currentSettings.searchBarPosition.y);searchContainer.style.top=100*e.percentY+"%",searchContainer.style.left=100*e.percentX+"%"}initializeShortcuts()}function createGroupPlaceholder(e){const t=document.createElement("div");return t.className="group placeholder glass-background",t.style.position="absolute",t.style.top=e.styleTop,t.style.left=e.styleLeft,t.style.width="150px",t.style.height="100px",t.style.opacity="0.3",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.textContent="Loading...",t}function getFavicon(e){const t="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItbGluayI+PHBhdGggZD0iTTEwIDEzYTUgNSAwIDAgMCA3LjU0LjU0bDMtM2E1IDUgMCAwIDAtNy4wNy03LjA3bC0xLjcyIDEuNzEiPjwvcGF0aD48cGF0aCBkPSJNMTQgMTFhNSA1IDAgMCAwLTcuNTQtLjU0bC0zIDNhNSA1IDAgMCAwIDcuMDcgNy4wN2wxLjcxLTEuNzEiPjwvcGF0aD48L3N2Zz4=";try{if(!e||""===e.trim())return t;let n;e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e);try{n=new URL(e)}catch(n){return Debugger.error("Invalid URL format:",e,n),t}const o=n.hostname;if(window.faviconCache||(window.faviconCache=new Map),"calendar.google.com"===o){const e=new Date,t="https://ssl.gstatic.com/calendar/images/dynamiclogo_2020q4/calendar_"+e.getDate().toString()+"_2x.png",n=`${o}_${e.toDateString()}`;return window.faviconCache.set(n,t),t}if(window.faviconCache.has(o))return window.faviconCache.get(o);if(!navigator.onLine)return t;const r={"mail.google.com":"https://www.gstatic.com/images/branding/product/1x/gmail_2020q4_32dp.png","drive.google.com":"https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.png","docs.google.com":"https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico","sheets.google.com":"https://ssl.gstatic.com/docs/spreadsheets/images/favicon_jfk2.png","slides.google.com":"https://ssl.gstatic.com/docs/presentations/images/favicon5.ico","meet.google.com":"https://www.gstatic.com/meet/favicon_meet_2023_32dp.png","chat.google.com":"https://www.gstatic.com/chat/favicon_chat_32px.png","classroom.google.com":"https://ssl.gstatic.com/classroom/favicon.png","keep.google.com":"https://ssl.gstatic.com/keep/icon_2020q4v2_32dp.png"};if(r[o]){const e=r[o];return window.faviconCache.set(o,e),e}const a=`https://www.google.com/s2/favicons?domain=${o}&sz=64`;return window.faviconCache.set(o,a),a}catch(n){return Debugger.warn("Error getting favicon for URL:",e,n),t}}document.addEventListener("DOMContentLoaded",(async()=>{try{const{settings:e,groups:t}=await fetchSettingsAndGroups();currentSettings={...defaultSettings,...e},applyTheme(),initializeSearch(),initializeHeaderLinks(),lazyRenderGroups(t),initializeAppsDropdown(),deferNonCritical(),setTimeout((()=>{if(currentSettings.useCustomBackground){document.body.classList.add("bg-transition");const e=(e,t)=>{if(!e)return void(t&&t(!1));const n=new Image;n.onload=function(){t&&t(!0,e)},n.onerror=function(){t&&t(!1)},n.src=e};if("undefined"!=typeof chrome&&chrome.storage&&chrome.storage.local)chrome.storage.local.get(["backgroundImage"],(t=>{const n=t.backgroundImage||currentSettings.backgroundURL;n&&e(n,((e,t)=>{e?(document.getElementById("background-image").style.backgroundImage=`url("${t}")`,document.getElementById("background-image").classList.add("background-image")):Debugger.warn("Failed to load background image:",n)})),document.querySelectorAll(".group.placeholder.glass-background").forEach((e=>e.remove()))}));else{const t=currentSettings.backgroundImage||currentSettings.backgroundURL;t&&e(t,((e,n)=>{e?(document.getElementById("background-image").style.backgroundImage=`url("${n}")`,document.getElementById("background-image").classList.add("bg-loaded")):Debugger.warn("Failed to load background image:",t)}))}}}),200)}catch(e){Debugger.error("Error initializing page:",e)}}));